# Development mode with hot reload
services:
  db:
    image: postgres:15-alpine
    container_name: iseb_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: iseb_prod
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD: ${DB_PASSWORD:-odoo}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U odoo"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - iseb-network

  redis:
    image: redis:7-alpine
    container_name: iseb_redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - iseb-network

  odoo:
    build:
      context: .
      dockerfile: Dockerfile
    image: iseb-platform:17.0
    container_name: iseb_odoo
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      HOST: db
      PORT: 5432
      USER: odoo
      PASSWORD: ${DB_PASSWORD:-odoo}
      ADMIN_PASSWD: ${ADMIN_PASSWORD:-admin}
      DB_MAXCONN: 64
      DB_TEMPLATE: template0
      WORKERS: ${WORKERS:-4}
      MAX_CRON_THREADS: 2
      LIMIT_MEMORY_SOFT: 2147483648
      LIMIT_MEMORY_HARD: 2684354560
      LIMIT_TIME_CPU: 600
      LIMIT_TIME_REAL: 1200
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOGFILE: /var/log/odoo/odoo.log
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - odoo-data:/var/lib/odoo
      - odoo-logs:/var/log/odoo
      - ./addons:/mnt/extra-addons:ro
      - ./config:/etc/odoo:ro
    ports:
      - "${ODOO_PORT:-8069}:8069"
      - "${LONGPOLLING_PORT:-8072}:8072"
    networks:
      - iseb-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8069/web/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  nginx:
    image: nginx:alpine
    container_name: iseb_nginx
    restart: unless-stopped
    depends_on:
      - odoo
    volumes:
      - ./nginx-cors.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8070:8070"
    networks:
      - iseb-network

  # DEVELOPMENT MODE - Hot reload enabled
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    image: iseb-frontend:dev
    container_name: iseb_frontend
    restart: unless-stopped
    depends_on:
      odoo:
        condition: service_healthy
    environment:
      ODOO_URL: http://nginx:8070
      ODOO_DB: iseb_prod
      NEXT_PUBLIC_ODOO_URL: http://localhost:8070
      NEXT_PUBLIC_APP_URL: http://localhost:3000
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change_this_in_production}
      NEXTAUTH_URL: http://localhost:3000
      NODE_ENV: development
    volumes:
      # Mount source code for hot reload (without node_modules and .next)
      - ./frontend/app:/app/app:rw
      - ./frontend/lib:/app/lib:rw
      - ./frontend/components:/app/components:rw
      - ./frontend/public:/app/public:rw
      - ./frontend/.env.local:/app/.env.local:ro
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    networks:
      - iseb-network

volumes:
  postgres-data:
    name: iseb_postgres_data
  redis-data:
    name: iseb_redis_data
  odoo-data:
    name: iseb_odoo_data
  odoo-logs:
    name: iseb_odoo_logs

networks:
  iseb-network:
    name: iseb_network
    driver: bridge
